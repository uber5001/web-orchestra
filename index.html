<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,width=device-width">
<title>Web Orchestra</title>
<script>
	window.AudioContext = window.AudioContext || window.webkitAudioContext;
	var context = new AudioContext();
	var comp = context.createDynamicsCompressor();
	comp.connect(context.destination);

	var socket = new WebSocket("ws://scottlittle.me:8082");

	var keymap = {
		49 :{x: 0, y:0, k:"1"},
		50 :{x: 1, y:0, k:"2"},
		51 :{x: 2, y:0, k:"3"},
		52 :{x: 3, y:0, k:"4"},
		53 :{x: 4, y:0, k:"5"},
		54 :{x: 5, y:0, k:"6"},
		55 :{x: 6, y:0, k:"7"},
		56 :{x: 7, y:0, k:"8"},
		57 :{x: 8, y:0, k:"9"},
		48 :{x: 9, y:0, k:"0"},
		189:{x:10, y:0, k:"-"},
		187:{x:11, y:0, k:"="},

		81 :{x: 0, y:1, k:"q"},
		87 :{x: 1, y:1, k:"w"},
		69 :{x: 2, y:1, k:"e"},
		82 :{x: 3, y:1, k:"r"},
		84 :{x: 4, y:1, k:"t"},
		89 :{x: 5, y:1, k:"y"},
		85 :{x: 6, y:1, k:"u"},
		73 :{x: 7, y:1, k:"i"},
		79 :{x: 8, y:1, k:"o"},
		80 :{x: 9, y:1, k:"p"},
		219:{x:10, y:1, k:"["},
		221:{x:11, y:1, k:"]"},
					 
		65 :{x: 0, y:2, k:"a"},
		83 :{x: 1, y:2, k:"s"},
		68 :{x: 2, y:2, k:"d"},
		70 :{x: 3, y:2, k:"f"},
		71 :{x: 4, y:2, k:"g"},
		72 :{x: 5, y:2, k:"h"},
		74 :{x: 6, y:2, k:"j"},
		75 :{x: 7, y:2, k:"k"},
		76 :{x: 8, y:2, k:"l"},
		186:{x: 9, y:2, k:";"},
		222:{x:10, y:2, k:"'"},
					  
		90 :{x: 0, y:3, k:"z"},
		88 :{x: 1, y:3, k:"x"},
		67 :{x: 2, y:3, k:"c"},
		86 :{x: 3, y:3, k:"v"},
		66 :{x: 4, y:3, k:"b"},
		78 :{x: 5, y:3, k:"n"},
		77 :{x: 6, y:3, k:"m"},
		188:{x: 7, y:3, k:","},
		190:{x: 8, y:3, k:"."},
		191:{x: 9, y:3, k:"/"}
	}
	
	window.onkeydown = function(e) {
		var k = keymap[e.keyCode];
		if (!k) return;
		playNote(2*k.x-5*k.y);
	}

	function playNote(val) {
		socket.send(val);
	}
	socket.onmessage = function(message) {
		var val = parseInt(message.data);
		var osc = context.createOscillator();
		osc.frequency.value = 440*Math.pow(2, val/12);
		var gain = context.createGain();

		gain.gain.setValueAtTime(1, context.currentTime);
		gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime+1);
		gain.gain.setValueAtTime(0, context.currentTime+1.01);


		osc.connect(gain);
		gain.connect(comp);
		osc.start(0);

		setTimeout(function() {
			osc.disconnect();
			gain.disconnect();
			osc.stop(0);
		}, 3000);
	}
	function iOSFix(target) {
		socket.onmessage({data:0});
		document.body.removeChild(target)
	}
</script>
</head>
<body>
	<button onclick="iOSFix(this)">Click here if your sound isn't working.</button>
</body>
</html>
